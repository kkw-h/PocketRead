# 接口文档 (API Doc)

**版本号**: 1.1
**作者**: 
**日期**: 
**基础URL**: `https://api.example.com/v1`

## 1. 概览
### 1.1 认证方式
- **Header**: `X-API-Key: <your_secret_key>`
- **说明**: 每个用户在 Cloudflare Worker 环境变量中配置 `API_KEY`，客户端需匹配该值。

### 1.2 全局错误码
| 错误码 | 说明 | 处理建议 |
| :--- | :--- | :--- |
| 401 | 无效的 API Key | 检查配置 |
| 500 | 服务器错误 | 查看 Worker 日志 |

## 2. 接口列表
### 2.1 系统模块
#### 2.1.1 健康检查 (连接测试)
- **URL**: `/health`
- **Method**: `GET`
- **Description**: 验证 API Key 是否有效，服务端是否正常。
- **Headers**:
  - `X-API-Key: <key>`
- **Response**:
```json
{
  "code": 200,
  "msg": "ok",
  "data": {
    "version": "1.0.0",
    "status": "healthy"
  }
}
```

### 2.2 阅读进度模块
#### 2.2.1 同步进度 (Sync Progress)
- **URL**: `/progress/sync`
- **Method**: `POST`
- **Description**: 上传本地进度，并获取云端更新的进度。
- **Request Body**:
```json
{
  "device_id": "uuid-v4-string",
  "sync_token": "last-sync-timestamp",
  "data": [
    {
      "book_id": "unique-book-id-1001",
      "chapter_idx": 5,
      "cfi": "epubcfi(/6/4[chap5ref]!/4/2/1:10)", 
      "anchor_text": "他推开门，看到了...",
      "percentage": 12.5,
      "timestamp": 1709880000,
      "is_deleted": false
    }
  ]
}
```
- **Response**:
```json
{
  "code": 200,
  "msg": "ok",
  "data": {
    "sync_token": "new-server-timestamp",
    "updates": [
      {
        "book_id": "unique-book-id-1002",
        "chapter_idx": 3,
        "cfi": "epubcfi(/6/12!/4/2)",
        "timestamp": 1709880500
      }
    ],
    "conflicts": []
  }
}
```

#### 2.2.2 获取单本书进度
- **URL**: `/progress/:book_id`
- **Method**: `GET`
- **Response**:
```json
{
  "code": 200,
  "data": {
    "book_id": "unique-book-id-1001",
    "chapter_idx": 5,
    "cfi": "epubcfi(/6/4[chap5ref]!/4/2/1:10)",
    "timestamp": 1709880000
  }
}
```

### 2.3 书籍管理模块 (Book Management)
#### 2.3.1 获取书架列表 (List Books)
- **URL**: `/books`
- **Method**: `GET`
- **Description**: 分页获取书架上的书籍列表。
- **Query Params**:
  - `page`: 页码 (default: 1)
  - `limit`: 每页数量 (default: 20)
  - `sort`: 排序字段 (e.g., `updated_at`, `title`)
- **Response**:
```json
{
  "code": 200,
  "data": {
    "items": [
      {
        "id": "unique-book-id-1001",
        "title": "三体",
        "author": "刘慈欣",
        "cover_url": "https://r2.example.com/covers/1001.jpg",
        "format": "epub",
        "file_size": 2048000,
        "created_at": 1709880000,
        "updated_at": 1709880000
      }
    ],
    "total": 1,
    "page": 1,
    "limit": 20
  }
}
```

#### 2.3.2 获取书籍详情 (Get Book Detail)
- **URL**: `/books/:id`
- **Method**: `GET`
- **Description**: 获取单本书籍的详细元数据。
- **Response**:
```json
{
  "code": 200,
  "data": {
    "id": "unique-book-id-1001",
    "title": "三体",
    "author": "刘慈欣",
    "description": "文化大革命如火如荼进行的同时...",
    "cover_url": "https://r2.example.com/covers/1001.jpg",
    "download_url": "https://api.example.com/v1/books/1001/download",
    "format": "epub",
    "file_size": 2048000,
    "md5": "a1b2c3d4e5f6...",
    "created_at": 1709880000,
    "updated_at": 1709880000
  }
}
```

#### 2.3.3 上传书籍 (Upload Book)
- **URL**: `/books`
- **Method**: `POST`
- **Content-Type**: `multipart/form-data`
- **Description**: 上传书籍文件（EPUB/TXT）及元数据。建议客户端解析元数据后一并提交。
- **Body**:
  - `file`: (File) 书籍文件
  - `cover`: (File, Optional) 封面图片文件
  - `title`: (String) 书名
  - `author`: (String) 作者
  - `format`: (String) 文件格式 (epub, txt)
  - `description`: (String, Optional) 简介
- **Response**:
```json
{
  "code": 200,
  "msg": "Upload successful",
  "data": {
    "id": "unique-book-id-1001",
    "title": "三体",
    "url": "https://r2.example.com/books/1001.epub"
  }
}
```

#### 2.3.4 删除书籍 (Delete Book)
- **URL**: `/books/:id`
- **Method**: `DELETE`
- **Description**: 从书架和云端存储中删除书籍。
- **Response**:
```json
{
  "code": 200,
  "msg": "Deleted successfully"
}
```

#### 2.3.5 下载书籍 (Download Book)
- **URL**: `/books/:id/download`
- **Method**: `GET`
- **Description**: 获取书籍文件内容。可能会返回 302 重定向到 R2 签名 URL，或直接流式返回文件内容。
- **Response**:
  - Status: 200 (Binary Stream) 或 302 (Redirect)
