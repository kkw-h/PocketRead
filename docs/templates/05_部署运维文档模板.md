# 部署运维文档 (Ops Doc)

**版本号**: 1.0
**作者**: 
**日期**: 

## 1. 概述
### 1.1 环境清单
| 环境 | URL | 用途 | 部署频率 |
| :--- | :--- | :--- | :--- |
| 开发 (Dev) | `dev-api.example.com` | 开发自测 | 每次 Push |
| 测试 (Staging) | `stg-api.example.com` | QA测试 | 每次 PR Merge |
| 生产 (Prod) | `api.example.com` | 线上服务 | 每周五/紧急发布 |

### 1.2 依赖服务
- **Cloudflare Workers**: 计算
- **Cloudflare D1**: 数据库
- **Cloudflare R2**: 存储
- **GitHub Actions**: CI/CD

## 2. 部署流程
### 2.1 自动化部署 (推荐)
通过 GitHub Actions 触发。
- **Prod**: `git push origin main` -> 触发 `deploy-prod.yml`
- **Staging**: `git push origin develop` -> 触发 `deploy-staging.yml`

### 2.2 手动部署 (应急)
1. **安装 Wrangler CLI**:
   `npm install -g wrangler`
2. **登录**:
   `wrangler login`
3. **配置环境变量**:
   `wrangler secret put API_KEY`
   (输入你自定义的强密码，如：`my_super_secure_key_123`)
4. **选择环境并部署**:
   `wrangler deploy --env production`

## 3. 监控与告警
### 3.1 关键指标
- **QPS (Requests/sec)**
- **Error Rate (%)**
- **CPU Time (ms/request)**
- **Latency (p95, p99)**

### 3.2 告警阈值
| 指标 | 阈值 | 级别 | 通知方式 |
| :--- | :--- | :--- | :--- |
| Error Rate | > 1% | P1 | Slack + PagerDuty |
| Latency p95 | > 500ms | P2 | Slack |

## 4. 故障排查 (Troubleshooting)
### 4.1 常见问题
- **502 Bad Gateway**: Worker 崩溃，查看 Logs
- **DB Connection Error**: D1 配额不足，查看 Dashboard

### 4.2 日志查询
- **实时日志**: `wrangler tail --env production`
- **历史日志**: Cloudflare Logpush -> S3/Splunk

## 5. 回滚策略 (Rollback)
### 5.1 快速回滚
1. 登录 Cloudflare Dashboard -> Workers -> Deployments
2. 找到上一个稳定版本 (e.g., `v1.2.3`)
3. 点击 "Rollback" 按钮

### 5.2 数据库回滚
- **D1 Snapshot**: 使用最近一次快照恢复 (需谨慎，会覆盖数据)
- `wrangler d1 backup restore <db_name> <backup_id>`
