# 跨平台小说阅读器项目规划书

**版本号**: 1.0  
**日期**: 2026-02-27  
**状态**: 拟定中  

---

## 目录

1. [项目概述](#1-项目概述)
2. [术语表](#2-术语表)
3. [项目架构设计](#3-项目架构设计)
4. [技术选型说明](#4-技术选型说明)
5. [核心功能模块规划](#5-核心功能模块规划)
6. [数据同步机制设计](#6-数据同步机制设计)
7. [用户界面设计规范](#7-用户界面设计规范)
8. [性能优化策略](#8-性能优化策略)
9. [安全与隐私保护措施](#9-安全与隐私保护措施)
10. [开发里程碑计划](#10-开发里程碑计划)
11. [团队分工方案](#11-团队分工方案)
12. [风险评估与应对措施](#12-风险评估与应对措施)
13. [预算估算](#13-预算估算)
14. [后续版本迭代规划](#14-后续版本迭代规划)

---

## 1. 项目概述

### 1.1 项目背景
随着移动互联网的普及，用户对于跨设备无缝阅读体验的需求日益增长。当前市场上的阅读器往往存在平台局限性或同步功能体验不佳的问题。本项目旨在开发一款高性能、全平台覆盖的小说阅读器，利用现代云技术实现极致的同步体验。

### 1.2 项目目标
构建一个支持 iOS, Android, Web 的跨平台小说阅读应用。核心目标包括：
- **多端同步**：实现阅读进度、书架、笔记的毫秒级多端实时同步。
- **极致体验**：提供流畅的翻页效果、舒适的排版和快速的加载速度。
- **自托管 (Self-Hosted)**：每个用户拥有独立的服务端（Cloudflare Workers），数据完全私有化，无需依赖第三方账号体系。

---

## 2. 术语表

| 术语 | 说明 |
| :--- | :--- |
| **Cloudflare Workers** | 无服务器计算服务，用户自行部署，用于处理业务逻辑。 |
| **Cloudflare D1** | 基于 SQLite 的边缘数据库，存储用户私有数据。 |
| **Cloudflare R2** | 对象存储服务，用于存储私有电子书文件。 |
| **Flutter** | Google 开源的 UI 工具包，用于通过一套代码构建多平台应用。 |
| **阅读进度** | 记录用户在特定书籍中的阅读位置。 |
| **API Key** | 用于客户端与自托管服务端通信的唯一凭证。 |

---

## 3. 项目架构设计

本项目采用 **Client-Server-Cloud** 三层架构，确保高可用性与低延迟。

### 3.1 总体架构图

```mermaid
graph TD
    User[用户] -->|访问| App(Flutter Mobile App)
    User -->|访问| Web(Flutter Web App)
    
    subgraph "客户端 (Flutter)"
        App -->|API请求| Gateway
        Web -->|API请求| Gateway
        LocalDB[本地数据库 (Hive/Isar)]
        SyncMgr[同步管理器]
    end
    
    subgraph "云端服务 (Cloudflare)"
        Gateway[Cloudflare Workers API Gateway]
        Auth[认证服务]
        BizLogic[业务逻辑处理]
        
        Gateway --> Auth
        Gateway --> BizLogic
        
        BizLogic --> D1[(Cloudflare D1 数据库)]
        BizLogic --> KV[(Cloudflare KV 缓存)]
        BizLogic --> R2[(Cloudflare R2 对象存储)]
    end
```

### 3.2 移动端架构 (iOS & Android)
- **UI层**: 使用 Flutter Widget 构建，Material Design 3 (Android) + Cupertino (iOS) 风格适配。
- **逻辑层**: 采用 BLoC 或 Riverpod 状态管理。
- **持久化层**: 使用 Isar 或 Hive 存储本地书籍、缓存和未同步的进度。
- **阅读引擎**: 自研排版引擎，支持 EPUB 解析、TXT 智能分章、自定义字体/背景。

### 3.3 Web端架构
- **渲染**: Flutter Web (CanvasKit) 提供一致的渲染效果。
- **适配**: 针对桌面浏览器进行键鼠操作优化（快捷键翻页等）。
- **PWA**: 支持 PWA 标准，允许用户安装到桌面，支持离线访问。

### 3.4 云端管理架构 (Serverless)
- **API 网关**: Cloudflare Workers 处理所有 HTTP 请求。
- **自托管模式**: 每个用户独立部署自己的 Workers + D1 + R2，数据物理隔离。
- **数据存储**: D1 (SQL) 存储书籍元数据；R2 存储书籍文件。
- **边缘计算**: 利用 Cloudflare 全球边缘节点，实现就近访问，降低延迟。

---

## 4. 技术选型说明

### 4.1 前端/移动端：Flutter
- **理由**: 
  - **一次编写，处处运行**：一套代码同时生成 iOS, Android, Web, macOS/Windows 应用。
  - **高性能**：Skia/Impeller 引擎直接渲染，性能接近原生。
  - **丰富的生态**：拥有成熟的阅读器相关插件（epub解析, 数据库等）。

### 4.2 云服务：Cloudflare 全家桶
- **Cloudflare Workers**: 免费额度 (10万次请求/天) 足够个人使用。
- **Cloudflare D1**: 边缘 SQL 数据库，读写速度快，免费额度 (5GB) 足够存储数万本书籍信息。
- **Cloudflare R2**: 兼容 S3 API 的对象存储，**无出口流量费**，免费额度 (10GB) 足够存储大量书籍。

---

## 5. 核心功能模块规划

### 5.1 服务端配置与连接
- **配置管理**: 输入 Cloudflare Worker URL 和 API Key 进行连接。
- **连接测试**: 验证服务端版本和 API Key 有效性。
- **多端同步**: 所有设备配置相同的 URL 和 Key 即可自动同步。

### 5.2 书架管理
- **书籍导入**: 支持本地导入 (Wi-Fi 传书, 文件选择) 和 URL 导入。
- **分组/分类**: 支持自定义书单、文件夹管理。
- **封面解析**: 自动提取 EPUB 封面，TXT 自动生成封面。
- **云端备份**: 书架列表自动备份至私有 D1 数据库。

### 5.3 阅读进度同步
- **核心机制**: 记录 `book_id`, `chapter_index`, `cfi` (EPUB Canonical Fragment Identifier) 或 `anchor_text` (TXT 文本锚点), `timestamp`, `device_id`。
- **一致性策略**: 
  - **EPUB**: 使用 CFI (e.g., `/6/4[chap1ref]!/4/2/1:0`) 精确定位到具体 DOM 元素或字符偏移，不受字号/屏幕尺寸影响。
  - **TXT**: 使用 "前20字符 + 后20字符" 的哈希锚点定位，避免因换行符差异导致的偏移。
- **冲突处理**: 采用“最后写入胜出 (Last Write Wins)”策略，结合时间戳校验。若时间戳差异 < 1分钟，提示用户手动选择。
- **实时性**: 阅读状态变更时，通过 WebSocket 或短轮询触发同步。
- **离线支持**: 优先写入本地数据库，网络恢复后自动增量同步。
- **安全性**: 进度数据在传输前进行 AES 加密，防止中间人窃听。
- **异常修复**: 自动检测进度回滚或跳跃异常，提供自动修复选项。

### 5.4 书籍资源管理
- **文件存储**: 书籍源文件上传至私有 R2 存储桶。
- **格式支持**: 首发支持 TXT, EPUB；后续支持 PDF。
- **预下载**: 智能分析阅读进度，提前缓存后续章节内容。

---

## 6. 数据同步机制设计

### 6.1 基于 Cloudflare 的实时同步方案
1.  **触发时机**: 
    - 启动时: 自动获取所有书籍最新进度。
    - 打开书籍时: 检查该书是否有云端更新。
    - 翻页/暂停: 超过 5秒自动上传。
    - 网络恢复: 触发离线队列同步。
2.  **数据包结构**:
    ```json
    {
      "api_key": "user_secret_key",
      "sync_token": "timestamp_uuid",
      "device_id": "mobile_01",
      "progress": [
        { 
          "book_id": "1001", 
          "chapter": 5, 
          "cfi": "epubcfi(/6/4[chap5ref]!/4/2/1:10)", 
          "anchor_text": "他推开门，看到了...",
          "percentage": 12.5, 
          "ts": 1709880000 
        }
      ]
    }
    ```
3.  **冲突策略**:
    - **自动合并**: 若云端时间戳 > 本地时间戳，且差异 > 1分钟，自动覆盖本地。
    - **手动解决**: 若差异 < 1分钟且位置不同，弹窗提示“发现云端新进度，是否跳转？”。

---

## 7. 用户界面设计规范

### 7.1 设计原则
- **沉浸式**: 阅读界面无干扰，隐藏状态栏和导航栏。
- **极简主义**: 减少非必要元素，突出内容。

### 7.2 移动端适配
- **手势操作**: 边缘侧滑返回，点击中央唤出菜单，左右滑动翻页。
- **夜间模式**: 真正的 OLED 纯黑模式。

### 7.3 Web端响应式布局
- **三栏布局**: 宽屏下显示“目录树 - 阅读区 - 笔记/设置”。
- **键盘支持**: 方向键翻页，空格键向下滚动。

---

## 8. 性能优化策略

### 8.1 加载速度
- **WebAssembly**: Flutter Web 编译为 WASM，提升启动速度和帧率。
- **资源CDN**: 默认使用 Cloudflare CDN 加速。

### 8.2 渲染性能
- **虚拟列表**: 书架和目录列表使用 `ListView.builder` 懒加载。
- **后台解析**: 书籍解析和排版计算在 Isolate (子线程) 中进行，避免阻塞 UI 线程。

### 8.3 流量节省
- **增量同步**: 仅同步变化的数据字段。
- **分块下载**: 大文件书籍支持 Range 请求，按需下载章节。

---

## 9. 安全与隐私保护措施

- **数据传输**: 全程强制 HTTPS (TLS 1.3)。
- **敏感数据**: 无需存储用户密码，仅需妥善保管 API Key。
- **内容安全**: R2 存储桶设置为私有，仅通过 API Key 鉴权后生成临时链接访问。
- **隐私**: 真正的数据私有化，开发团队无法访问用户的任何阅读数据。

---

## 10. 开发里程碑计划

| 阶段 | 时间节点 | 主要任务 | 交付物 |
| :--- | :--- | :--- | :--- |
| **P1: 需求与设计** | T+0 ~ T+2周 | 需求细化、UI/UX 设计、技术架构验证 | PRD文档、Figma设计稿、API 接口定义 |
| **P2: 核心开发** | T+2 ~ T+6周 | 服务端配置功能、书架功能、阅读器引擎 | 移动端 MVP (可连接自建后端) |
| **P3: 云端与同步** | T+6 ~ T+9周 | Cloudflare Worker 模板开发、部署脚本 | 一键部署脚本、多端同步功能打通 |
| **P4: 测试与优化** | T+9 ~ T+11周 | 性能测试、Bug修复、UI细节打磨 | Beta 测试包 |
| **P5: 上线部署** | T+12周 | 应用商店审核、开源仓库发布 | App Store 上架、GitHub 开源 |

---

## 11. 团队分工方案

- **项目经理 (PM)**: 1人。负责进度把控、需求协调、里程碑验收。
- **UI/UX 设计师**: 1人。负责全平台界面设计、图标绘制。
- **Flutter 工程师**: 2人。负责移动端和 Web 端开发。
  - A: 负责阅读器核心引擎、本地数据库。
  - B: 负责 UI 交互、网络层、服务端配置模块。
- **后端工程师**: 1人。负责 Cloudflare Workers 模板代码、一键部署脚本。
- **测试工程师 (QA)**: 1人。负责功能测试、兼容性测试。

---

## 12. 风险评估与应对措施

| 风险点 | 风险等级 | 应对措施 |
| :--- | :--- | :--- |
| **Cloudflare 访问限制** | 中 | 在特定地区配置优选 IP 或备用域名；客户端内置网络诊断。 |
| **EPUB 格式兼容性** | 高 | 建立测试用例库，覆盖各种不规范 EPUB；使用鲁棒性强的解析库。 |
| **用户部署门槛** | 高 | 提供傻瓜式“一键部署”脚本 (NPM/Shell) 和详细的图文教程。 |
| **同步冲突** | 低 | 完善冲突解决算法，保留最后一次手动操作记录。 |

---

## 13. 预算估算

### 13.1 基础设施成本 (月估)
- **Cloudflare Free Tier**: 
  - Workers: 10万请求/天 (个人完全够用)。
  - R2: 10GB 存储 + 1000万次读操作/月 (个人完全够用)。
  - D1: 5GB 存储 + 500万次读操作/月 (个人完全够用)。
- **总计**: **$0 / 月** (只要在免费额度内)。

### 13.2 人力成本 (估算)
- 按照 3 个月开发周期，5-6 人团队计算（此处仅为工时参考，具体视薪资标准而定）。

---

## 14. 后续版本迭代规划

- **v1.1**: 增加 TTS 听书功能；增加深色模式自定义。
- **v1.2**: 支持 PDF 格式重排阅读；增加笔记/划线导出 (Markdown/Evernote)。
- **v2.0**: 引入社区功能（书评、分享）；引入 AI 辅助阅读（角色分析、摘要生成）。

---
**文档结束**
